---
title: "6章_図で理解する重回帰モデルの基礎"
output: html_document
date: '2022-05-18'
---
1人当たりの国内総生産を交絡因子の候補として、ノーベル賞受賞者数とチョコレート消費量の関係について検証する。

# データの読込み
y1は人口1千万人当たりのノーベル賞受賞者、x1は人口1人当たりの年間のチョコレート消費量（kg）、x2は1人当たりの国内総生産である。
```{r}
rm(list = ls())
d <- read.csv("data06.csv")
head(d)
```
```{r}
attach(d)
n <- nrow(d)
n
```
# 分散
以下より変数Yの不偏分散を求めることができる。変数Yの個々の値と変数Yの平均値との距離である偏差を計算し、その偏差を二乗してから足した偏差平方和を自由度n-1で割った値である。
$$
   var[Y_i] = \frac{1}{n-1} \sum_{i=1}^n (Y_i-\bar Y)^2
$$

```{r}
hensa <- y1 - mean(y1)
hensa2 <- hensa^2
tss <- sum(hensa2)
```

```{r}
tss
tss/(n - 1)
var(y1)
```

# ESSとUSS
```{r}
model <- lm(y1 ~ x1)
summary(model)
confint(model, level=0.95)
```
y1とx1の単回帰モデルより、人口1人当たりの年間のチョコレート消費量x1が1kg多いと、人口1千万人当たりのノーベル賞受賞者は約2.7044人多いと解釈できる。また、95%信頼区間は1.460〜3.949より5%有意水準で帰無仮説$\beta_1 = 0$を棄却できる。

```{r}
plot(x1, y1)
```

$X_1$を説明変数とする単回帰モデルから説明できるYの変動部分をESS（Explained Sum of Squares）といい、以下より求めることができる。

$$
  ESS = \sum_{i=1}^n (\hat Y_i - \bar Y)^2
$$

```{r}
# 予測値
yhat1 <- -3.4217 + 2.7044 * x1
predict(model)

# ESS
yhat2 <- (yhat1 - mean(y1))^2
ess <- sum(yhat2)

yhat2
ess
```

$X_1$を説明変数とする単回帰モデルから説明できないYの変動部分をUSS（Unexplained Sum of Squares）といい、以下より求めることができる。

$$
  USS = \sum_{i=1}^n (Y_i - \hat Y)^2 = \sum_{i=1}^n e_i^2
$$

```{r}
# uss
e1 <- y1 - yhat1  # 残差（手動計算）
e2 <- e1^2
uss <- sum(e2)

resid(model)　# 残差（関数）
```

ESSが大きいほど、2つの変数の関連性が大きいことを示しており、USSが大きいほどモデルの説明力が小さいことを示している。

# 決定係数
$X_1$を説明変数とする単回帰モデルから説明できるYの変動部分の割合を決定係数といい、以下より求めることができる。
$$
　R^2 = 1 - \frac{USS}{TSS}
$$

```{r}
1 - uss/tss
summary(model)$r.squared
```

# 三変数の重回帰モデル
$Y_i = \beta_0 + \beta_1 X_{1i} + \beta_2 X_{2i} + \epsilon_i$における$\beta_i$の偏りのない推定を行う。
```{r}
model1 <- lm(x1 ~ x2)       # x2からx1の予測値を計算
ex1 <- resid(model1)　　    # x1とx1の予測値の残差を計算
model2 <- lm(y1 ~ ex1)      # 残差からy1の予測値を計算
model3 <- lm(y1 ~ x1 + x2)  # 重回帰モデル
```

二段階の推定モデル
```{r}
summary(model2)
```

重回帰モデル
```{r}
summary(model3)
```

```{r}
confint(model3, level=0.95)
```
二段階の推定モデル、重回帰モデルどちらの方法でも、偏回帰係数$\hat \beta_1$は1.505と推定される。また、95%信頼区間はまた、95%信頼区間は-0.073〜3.3082であり、区間の中に0が含まれるため、5%の有意水準で帰無仮説$\beta_1=0$を棄却できない。よって、人口1人当たりの年間のチョコレート消費量x1が1kg多いと、人口1千万人当たりのノーベル賞受賞者y1は約1.505人増えると解釈できるが、5%の有意水準で統計的に有意でないため、1人当たりの国内総生産x2を考慮に入れると、x1はy1に対して因果的な効果を持っているとは言えないと結論付けられる。
